import { Component, OnInit } from '@angular/core';
import { ExploitationService} from '../../Service/exploitation.service';
import{Exploitation, Parcelle } from '../../models/exploitation.model';
import { CommonModule } from '@angular/common';
import { HttpClientModule } from '@angular/common/http';
import { FormsModule } from '@angular/forms';
@Component({
  selector: 'app-exploitation',
  standalone: true,
  imports: [CommonModule, FormsModule,HttpClientModule],
  templateUrl: './exploitation.component.html',
  styleUrls: ['./exploitation.component.css']
})
export class ExploitationComponent implements OnInit {

  // ===== LIST =====
  exploitations: Exploitation[] = [];

  // ===== FORM EXPLOITATION =====
  exploitation: Exploitation = {
    nom: '',
    localisation: '',
    responsable: '',
    surfaceTotale: 0,
    parcelles: []
  };

  // ===== FORM PARCELLE =====
  parcelle: Parcelle = {
    culture: '',
    surface: 0,
    etat: ''
  };

  constructor(private service: ExploitationService) {}

  // ===== INIT =====
  ngOnInit(): void {
    this.load();
  }

  // ===== LOAD LIST (FIX BUG) =====
  load(): void {
    this.service.getAll().subscribe({
      next: (data) => {
        this.exploitations = data ?? [];
      },
      error: (err) => {
        console.error('Erreur chargement exploitations', err);
        this.exploitations = [];
      }
    });
  }

  // ===== PARCELLE =====
  addParcelle(): void {
    if (!this.exploitation.parcelles) {
      this.exploitation.parcelles = [];
    }

    this.exploitation.parcelles.push({ ...this.parcelle });

    this.parcelle = {
      culture: '',
      surface: 0,
      etat: ''
    };
  }

  removeParcelle(index: number): void {
    this.exploitation.parcelles?.splice(index, 1);
  }

  // ===== SAVE EXPLOITATION =====
  save(): void {
    this.service.create(this.exploitation).subscribe({
      next: () => {
        this.resetForm();
        this.load();
      },
      error: (err) => {
        console.error('Erreur création exploitation', err);
      }
    });
  }

  // ===== DELETE =====
  delete(id: number): void {
    if (!confirm('تمسح exploitation ؟')) return;

    this.service.delete(id).subscribe({
      next: () => this.load(),
      error: (err) => console.error('Erreur suppression', err)
    });
  }

  // ===== RESET FORM =====
  resetForm(): void {
    this.exploitation = {
      nom: '',
      localisation: '',
      responsable: '',
      surfaceTotale: 0,
      parcelles: []
    };
  }
}